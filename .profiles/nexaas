#!/usr/bin/env
export MYFINANCE_HOME="${HOME}/projects/myfinance"
export JAVA_HOME=$(readlink -f /usr/bin/javac | sed "s:bin/javac::")

alias cdm='cd ${HOME}/projects/nexaas/myfinance'
alias cdk='cd ${HOME}/projects/nexaas/estoka'

alias rdbdr='bundle exec rake db:data:reset db:test:prepare;'
alias gbdm='git branch -d $(git branch --merged | grep -v "\*\|deploy$")'

alias watch-asg-production='watch -n 5 as-describe-auto-scaling-groups myfinance-production-ASG-WK63242C95K7'
alias watch-elb-production='watch -n 5 elb-describe-instance-health myfinance-prod-ELB-10E1045ZCLZ8Z'

alias depiproduction='echo "@all fazendo deploy do app myfinance para production a partir do branch deploy em $(git rev-parse HEAD)" | pbcopy'
alias aws-auth-prod='ec2-authorize myfinance-ProductionSG-JM6T2EAL96NH -P tcp -p 22 -s '
alias aws-revoke-prod='ec2-revoke myfinance-ProductionSG-JM6T2EAL96NH -P tcp -p 22 -s '

alias pr='hub pull-request -r dansdantas'
alias prb='hub pull-request -l bug -l wip -r dansdantas'
alias prf='hub pull-request -l feature -l wip -r dansdantas'
alias pre='hub pull-request -l enhancement -l wip -r dansdantas'
alias ds='dc up deps'
alias amssh="ssh -i ${HOME}/.amazon/myfreecomm-AWS-US-East.pem"

loadfile $HOME/.certmanrc

function mf-auth() {
  ip=$(dig +short myip.opendns.com @resolver1.opendns.com)
  echo $ip
  ec2-authorize $1 -P tcp -p 22 -s $ip/32
  cmd="ec2-revoke myfinance-ProductionSG-JM6T2EAL96NH -P tcp -p 22 -s $ip/32"
  echo $cmd >> $2
  chmod 777 $2
}

function mf-revoke() {
  echo $1
  sh $1
  read -r -p "Remove ip file ? [Y/n] " response
  if [[ $response =~ ^([nN][oO]|[nN])$ ]]
  then
    exit 0
  fi
  rm $2
}

alias mf-auth-prod="mf-auth myfinance-ProductionSG-JM6T2EAL96NH ~/mf-ec2-prod-ip"
alias mf-revoke-prod="mf-revoke myfinance-ProductionSG-JM6T2EAL96NH ~/mf-ec2-prod-ip"

function mf-debug-sand() {
  cd $MYFINANCE_HOME
  echo "Creating debugging pod..."
  kubectl create -f ops/k8s/sandbox/myfinance-console-pod.yaml &&
  sleep 15 &&
  echo "Opening rails console..." &&
  mf-rails-console-k8 &&
  echo "Removing debugging pod..." &&
  mf-remove-debug-pod
}

function mf-remove-debug-pod() {
  kubectl delete -f ops/k8s/myfinance-console-pod.yaml
}

function mf-rails-console-k8() {
  setTerminatorProfile sandbox
  kubectl exec -it myfinance-console -- bundle exec rails console
  setTerminatorProfile default
}

function mf-ssh-k8() {
  setTerminatorProfile sandbox
  kubectl exec -it myfinance-console -- bash
  setTerminatorProfile default
}
